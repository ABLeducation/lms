{% extends 'teacher_template/base_template.html' %}

{% block page_title %}
    Competition
{% endblock page_title %}

{% block main_content %}
    {% load static %}
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Fill Competition Details</h3>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="form-group row">
                                    <label for="id_competition_name" class="col-sm-2 col-form-label">Competition Name</label>
                                    <div class="col-sm-10">
                                        {{ form.competition_name }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_venue" class="col-sm-2 col-form-label">Venue</label>
                                    <div class="col-sm-10">
                                        {{ form.venue }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_date" class="col-sm-2 col-form-label">Date</label>
                                    <div class="col-sm-10">
                                        {{ form.date }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_status" class="col-sm-2 col-form-label">Status</label>
                                    <div class="col-sm-10">
                                        {{ form.status }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_school" class="col-sm-2 col-form-label">School</label>
                                    <div class="col-sm-10">
                                        {{ form.school }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_grade" class="col-sm-2 col-form-label">Grade</label>
                                    <div class="col-sm-4">
                                        {{ form.grade }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_section" class="col-sm-2 col-form-label">Section</label>
                                    <div class="col-sm-4">
                                        {{ form.section }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="id_student" class="col-sm-2 col-form-label">Student</label>
                                    <div class="col-sm-4">
                                        {{ form.student }}
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-10 offset-sm-2">
                                        <button type="submit" class="btn btn-primary">Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const schoolField = document.getElementById('id_school');
            const gradeField = document.getElementById('id_grade');
            const sectionField = document.getElementById('id_section');
            const studentField = document.getElementById('id_student');

            function loadSections() {
                const schoolId = schoolField.value;
                const gradeId = gradeField.value;
                const url = '{% url "users:load_sections" %}?school=' + encodeURIComponent(schoolId) + '&grade=' + encodeURIComponent(gradeId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        let options = '<option value="">---------</option>';
                        data.forEach(section => {
                            options += `<option value="${section}">${section}</option>`;
                        });
                        sectionField.innerHTML = options;
                        studentField.innerHTML = '<option value="">---------</option>'; // Clear students when section changes
                    });
            }

            function loadStudents() {
                const schoolId = schoolField.value;
                const gradeId = gradeField.value;
                const sectionId = sectionField.value;
                const url = '{% url "users:load_students" %}?school=' + encodeURIComponent(schoolId) + '&grade=' + encodeURIComponent(gradeId) + '&section=' + encodeURIComponent(sectionId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        let options = '<option value="">---------</option>';
                        data.forEach(student => {
                            options += `<option value="${student.user_id}">${student.first_name} ${student.middle_name} ${student.last_name}</option>`;
                        });
                        studentField.innerHTML = options;
                    });
            }

            schoolField.addEventListener('change', loadSections);
            gradeField.addEventListener('change', loadSections);
            sectionField.addEventListener('change', loadStudents);

        });
    </script>
{% endblock main_content %}

{% block custom_js %}
{% endblock custom_js %}
